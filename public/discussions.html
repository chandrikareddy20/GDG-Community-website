<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GDG Community | Discussions</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
  body { background-color: #f5f6fa; color: #333; padding-top: 80px; }

  /* Header (Same as gallery) */
  header {
    background: white;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    width: 100%;
    position: fixed;
    top: 0; left: 0;
    z-index: 999;
  }
  .navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 40px;
    max-width: 1400px;
    margin: auto;
  }
  .logo {
    font-weight: bold;
    font-size: 20px;
  }
  nav ul {
    list-style: none;
    display: flex;
    gap: 25px;
  }
  nav a {
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: color 0.3s ease;
  }
  nav a:hover, nav a.active {
    color: #1a73e8;
  }
  .join-btn {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
  }

  /* Hero Section */
  .hero {
    background: linear-gradient(90deg, #16a34a, #0d9488);
    color: white;
    text-align: center;
    padding: 60px 20px;
    position: relative;
  }
  .hero h1 { font-size: 44px; margin-bottom: 10px; }
  .new-discussion-btn {
    position: absolute;
    right: 40px; top: 50%; transform: translateY(-50%);
    background: white; color: #0d9488; border: none;
    padding: 10px 18px; font-weight: 600; border-radius: 8px;
    cursor: pointer;
  }

  /* Search bar */
  .search-bar {
    margin: 30px auto;
    max-width: 700px;
    display: flex;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 10px 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .search-bar input {
    border: none; outline: none; flex: 1; font-size: 16px;
  }

  /* Tabs */
  .tabs {
    display: flex; justify-content: center;
    gap: 10px; margin-bottom: 20px;
  }
  .tab {
    background: white; border: 1px solid #ddd;
    border-radius: 10px; padding: 10px 24px;
    cursor: pointer; font-weight: 500; transition: all 0.2s ease;
  }
  .tab.active {
    background-color: #1a73e8;
    color: white;
  }

  /* Discussion cards */
  .discussion-list {
    max-width: 900px;
    margin: 0 auto 40px;
  }
  .discussion-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
  }
  .discussion-header {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .discussion-header img {
    width: 40px; height: 40px; border-radius: 50%;
  }
  .discussion-content { margin-top: 10px; line-height: 1.5; }
  .tags {
    margin-top: 12px;
    display: flex; flex-wrap: wrap; gap: 8px;
  }
  .tag {
    background: #e9f1ff; color:#0d9488;
    padding: 4px 10px; border-radius: 6px;
    font-size: 13px; font-weight: 500;
  }
  .discussion-footer {
    display: flex; gap: 20px; margin-top: 12px;
    font-size: 15px; color: #555;
  }

  /* Replies */
  .reply-section {
    margin-top: 15px;
    border-top: 1px solid #eee;
    padding-top: 10px;
  }
  .reply-input {
    display: flex; gap: 8px; margin-top: 10px;
  }
  .reply-input input {
    flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
  }
  .reply-input button {
    background: #1a73e8; color: white; border: none;
    padding: 8px 14px; border-radius: 6px; cursor: pointer;
  }
  .reply {
    background: #f1f3f4;
    padding: 8px 10px;
    border-radius: 8px;
    margin-top: 6px;
    font-size: 14px;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background: white;
    padding: 25px;
    border-radius: 10px;
    width: 90%; max-width: 500px;
    position: relative;
  }
  .close-btn {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none;
    font-size: 20px; cursor: pointer;
  }
  .modal-content input, .modal-content textarea {
    width: 100%; margin-top: 10px;
    padding: 8px; border-radius: 6px; border: 1px solid #ccc;
  }
  #postBtn {
    margin-top: 15px;
    background: #1a73e8;
    color: white; padding: 10px;
    border: none; width: 100%;
    border-radius: 6px; cursor: pointer;
  }
</style>
</head>
<body>

<!-- Navbar -->
<header>
  <div class="navbar">
    <div class="logo">
      <span style="color:#ea4335;">‚óè</span>
      <span style="color:#fbbc05;">‚óè</span>
      <span style="color:#34a853;">‚óè</span>
      <span style="color:#4285f4;">‚óè</span>
      <strong>GDG Community</strong>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">üè† Home</a></li>
        <li><a href="events.html">üìÖ Events</a></li>
        <li><a href="gallery.html">üñºÔ∏è Gallery</a></li>
        <li><a href="discussions.html" class="active">üí¨ Discussions</a></li>
      </ul>
    </nav>
    <button class="join-btn">Join Community</button>
  </div>
</header>

<!-- Hero -->
<section class="hero">
  <h1>Discussions</h1>
  <p>Ask questions, share ideas, and collaborate with the community</p>
  <button class="new-discussion-btn" id="openModal">Ôºã New Discussion</button>
</section>

<!-- Search -->
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="üîç Search discussions by title, content, or tags...">
</div>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" data-target="recent">‚è±Ô∏è Recent</div>
  <div class="tab" data-target="popular">üìà Popular</div>
</div>

<!-- Discussions -->
<div id="recent" class="discussion-list"></div>
<div id="popular" class="discussion-list" style="display:none;"></div>

<!-- Modal -->
<div class="modal" id="discussionModal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">‚úñ</button>
    <h2>New Discussion</h2>
    <input type="text" id="title" placeholder="Discussion Title" required>
    <input type="text" id="author" placeholder="Your Name" required>
    <textarea id="content" rows="4" placeholder="Write your discussion..." required></textarea>
    <input type="text" id="tags" placeholder="Tags (comma separated)">
    <button id="postBtn">Post Discussion</button>
  </div>
</div>

<!-- Firebase Logic -->
<script type="module">
  import { app, db } from "../firebase-config.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, arrayUnion, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const auth = getAuth(app);
  let authReady = false;
  onAuthStateChanged(auth, (user) => authReady = !!user);
  // attempt sign-in proactively (harmless if already signed in or disabled)
  try { signInAnonymously(auth).catch(()=>{}); } catch(e) { /* ignore */ }
  async function ensureAnonymousSignIn() {
    if (authReady) return true;
    try { await signInAnonymously(auth); authReady = true; return true; }
    catch (err) { console.warn('Sign-in failed:', err); return false; }
  }

  const modal = document.getElementById("discussionModal");
  document.getElementById("openModal").onclick = () => modal.style.display = "flex";
  document.getElementById("closeModal").onclick = () => modal.style.display = "none";
  window.onclick = (e) => { if (e.target === modal) modal.style.display = "none"; };

  const recentList = document.getElementById("recent");
  function renderDiscussions(discussions) {
    recentList.innerHTML = "";
    discussions.forEach((d, i) => {
      const card = document.createElement("div");
      card.className = "discussion-card";
      // build replies HTML
      const parentReplies = (d.replies || []);
      // store for merging with subcollection replies
      parentRepliesMap.set(d.id, parentReplies);
      const parentRepliesHtml = parentReplies.map(r => {
        // replies stored on parent doc (array)
        if (typeof r === 'string') return `<div class="reply">${r}</div>`;
        return `<div class="reply"><strong>${r.userId ? 'User' : ''}</strong> ${r.text || r}</div>`;
      }).join('');

      card.innerHTML = `
        <div class="discussion-header">
          <img src="https://randomuser.me/api/portraits/lego/${i % 10}.jpg">
          <div><strong>${d.title}</strong><br><small>${d.author} ‚Ä¢ ${d.time}</small></div>
        </div>
        <div class="discussion-content">${d.content}</div>
        <div class="tags">${(d.tags || []).map(t => `<span class="tag">${t}</span>`).join("")}</div>
        <div class="discussion-footer">
          <button class="like-btn" data-id="${d.id}">‚ù§Ô∏è ${d.likes ?? 0}</button>
          <span>üí¨ ${d.replies?.length || 0} replies</span>
        </div>
        <div class="reply-section" id="reply-section-${d.id}">
          <div class="replies-parent">${parentRepliesHtml}</div>
          <div class="replies-sub" id="replies-sub-${d.id}"></div>
          <div class="reply-input">
            <input data-reply-for="${d.id}" placeholder="Write a reply..." />
            <button class="reply-post-btn" data-id="${d.id}">Reply</button>
          </div>
        </div>
      `;
      recentList.appendChild(card);
      // attach listener for subcollection replies (only once)
      attachSubRepliesListener(d.id);
    });
  }

  // Keep track of attached listeners so we don't attach duplicates
  const replyListeners = new Map();
  // Keep parent-array replies so we can merge with subcollection replies
  const parentRepliesMap = new Map();
  function attachSubRepliesListener(discussionId) {
    if (!discussionId) return;
    if (replyListeners.has(discussionId)) return;
    try {
      const subColl = collection(db, 'discussions', discussionId, 'replies');
      const subQuery = query(subColl, orderBy('createdAt', 'asc'));
      const unsubscribe = onSnapshot(subQuery, (snap) => {
        const el = document.getElementById(`replies-sub-${discussionId}`);
        if (!el) return;
        // build array of replies: parent ones (from map) + subcollection ones
        const parent = parentRepliesMap.get(discussionId) || [];
        const subs = [];
        snap.forEach(sd => subs.push(sd.data()));
        // normalize createdAt to milliseconds for sorting
        const toMs = (r) => {
          if (!r || !r.createdAt) return 0;
          // Firestore Timestamp
          if (typeof r.createdAt.toMillis === 'function') return r.createdAt.toMillis();
          // JS Date
          if (r.createdAt instanceof Date) return r.createdAt.getTime();
          // number
          if (typeof r.createdAt === 'number') return r.createdAt;
          return 0;
        };
        const combined = [...parent.map(p => (typeof p === 'string' ? { text: p, createdAt: 0 } : p)), ...subs];
        combined.sort((a, b) => (toMs(a) - toMs(b)));
        el.innerHTML = '';
        combined.forEach(r => {
          const html = `<div class="reply"><strong>${r.userId ? 'User' : ''}</strong> ${r.text || ''}</div>`;
          el.innerHTML += html;
        });
      }, (err) => {
        console.error('onSnapshot error for sub-replies', discussionId, err);
      });
      replyListeners.set(discussionId, unsubscribe);
    } catch (e) {
      console.error('Failed to attach sub-replies listener', discussionId, e);
    }
  }

  // Delegated handlers for likes and replies
  document.addEventListener('click', async (e) => {
    // Like button
    if (e.target && e.target.matches('.like-btn')) {
      const id = e.target.dataset.id;
      try {
        const ok = await ensureAnonymousSignIn();
        if (!ok) return alert('Could not sign in. Enable Anonymous auth in Firebase or sign in.');
        await updateDoc(doc(db, 'discussions', id), { likes: increment(1) });
        console.log('Liked discussion', id);
      } catch (err) {
        console.error('Failed to like discussion', err);
        alert('Failed to like discussion. Check console for details.');
      }
    }

    // Post reply
    if (e.target && e.target.matches('.reply-post-btn')) {
      const id = e.target.dataset.id;
      const input = document.querySelector(`input[data-reply-for="${id}"]`);
      const text = input?.value.trim();
      if (!text) return;
      const errorElId = `reply-error-${id}`;
      // ensure an inline error element exists
      let errorEl = document.getElementById(errorElId);
      if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.id = errorElId;
        errorEl.style.color = 'red';
        errorEl.style.marginTop = '6px';
        const wrap = input.parentElement;
        wrap.parentElement.insertBefore(errorEl, wrap.nextSibling);
      }
      errorEl.textContent = '';
      try {
        const ok = await ensureAnonymousSignIn();
        if (!ok) { errorEl.textContent = 'Unable to sign in. Enable Anonymous Auth.'; return; }
        try {
          await updateDoc(doc(db, 'discussions', id), { replies: arrayUnion({ text, userId: auth.currentUser?.uid || null, createdAt: serverTimestamp() }) });
          input.value = '';
          console.log('Posted reply to', id);
        } catch (updateErr) {
          console.warn('arrayUnion update failed, trying replies subcollection', updateErr);
          // fallback: write to subcollection discussions/{id}/replies
          try {
            await addDoc(collection(db, 'discussions', id, 'replies'), { text, userId: auth.currentUser?.uid || null, createdAt: serverTimestamp() });
            input.value = '';
            console.log('Saved reply to subcollection for', id);
          } catch (subErr) {
            console.error('Failed to save reply in subcollection', subErr);
            errorEl.textContent = 'Failed to save reply. Check console for details.';
          }
        }
      } catch (err) {
        console.error('Failed to post reply', err);
        errorEl.textContent = 'Failed to post reply. Check console for details.';
      }
    }
  });

  const q = query(collection(db, "discussions"), orderBy("createdAt", "desc"));
  try {
    onSnapshot(q, (snapshot) => {
      try {
        console.log('discussions snapshot', snapshot.size, snapshot.docs.map(d=>d.id));
        const discussions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderDiscussions(discussions);
      } catch (e) {
        console.error('Error rendering discussions snapshot', e);
      }
    }, (err) => {
      console.error('onSnapshot error for discussions:', err);
    });
  } catch (e) {
    console.error('Failed to attach onSnapshot to discussions query', e);
  }

  document.getElementById("postBtn").onclick = async () => {
    const title = document.getElementById("title").value.trim();
    const author = document.getElementById("author").value.trim();
    const content = document.getElementById("content").value.trim();
    const tags = document.getElementById("tags").value.split(",").map(t => t.trim()).filter(Boolean);
    if (!title || !author || !content) return alert("Please fill all fields!");
    try {
      const ok = await ensureAnonymousSignIn();
      if (!ok) return alert('Unable to sign in. Enable Anonymous Auth or sign in.');
      const ref = await addDoc(collection(db, "discussions"), {
        title, author, content, tags, likes: 0, replies: [],
        time: "Just now", createdAt: serverTimestamp()
      });
      console.log('Created discussion', ref.id);
      modal.style.display = "none";
    } catch (err) {
      console.error('Failed to post discussion', err);
      alert('Failed to post discussion. Check console for details.');
    }
  };
</script>
</body>
</html>
